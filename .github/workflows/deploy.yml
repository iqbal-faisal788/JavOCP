name: Build & Deploy to OpenShift

on:
  push:
    branches: [ "main" ]

env:
  IMAGE_NAME: ghcr.io/org/app
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Login to registry
      run: |
        echo "${{ secrets.REGISTRY_PASSWORD }}" | \
        docker login ghcr.io -u ${{ secrets.REGISTRY_USERNAME }} --password-stdin

    - name: Build image
      run: |
        docker build -t $IMAGE_NAME:$IMAGE_TAG .

    - name: Push image
      run: |
        docker push $IMAGE_NAME:$IMAGE_TAG

    - name: Install oc CLI
      uses: redhat-actions/oc-installer@v1
      with:
        version: "latest"

    - name: Login to OpenShift
      run: |
        oc login ${{ secrets.OPENSHIFT_SERVER }} \
          --token=${{ secrets.OPENSHIFT_TOKEN }} \
          --insecure-skip-tls-verify

    - name: Deploy
      run: |
        oc project ${{ secrets.OPENSHIFT_NAMESPACE }}
        oc set image deployment/app app=$IMAGE_NAME:$IMAGE_TAG
        oc rollout status deployment/app
